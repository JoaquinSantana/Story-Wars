<% if @story.created_at > 1.hour.ago %>
    <% round = 2 %>
    <% vote = false %>
<% elsif @story.created_at <= 1.hour.ago && @story.created_at > 2.hour.ago %>
    <% round = 2 %>
    <% vote = true %>
<% elsif @story.created_at < 2.hour.ago && @story.created_at > 3.hour.ago %>
    <% round = 3 %>
    <% vote = false %>
<% elsif @story.created_at < 3.hour.ago && @story.created_at > 4.hour.ago %>
    <% round = 3 %>
    <% vote = true %>
<% elsif @story.created_at < 4.hour.ago && @story.created_at > 5.hour.ago %>
    <% round = 4 %>
    <% vote = false %>
<% elsif @story.created_at < 5.hour.ago && @story.created_at > 6.hour.ago %>
    <% round = 4 %>
    <% vote = true %>
<% elsif @story.created_at < 6.hour.ago && @story.created_at > 7.hour.ago %>
    <% round = 5 %>
    <% vote = false %>
<% elsif @story.created_at < 7.hour.ago && @story.created_at > 8.hour.ago %>
    <% round = 5 %>
    <% vote = true %>
<% elsif @story.created_at < 8.hour.ago && @story.created_at > 9.hour.ago %>
    <% round = 6 %>
    <% vote = false %>
<% elsif @story.created_at < 9.hour.ago && @story.created_at > 10.hour.ago %>
    <% round = 6 %>
    <% vote = true %>
<% elsif @story.created_at < 10.hour.ago && @story.created_at > 11.hour.ago %>
    <% round = 7 %>
    <% vote = false %>
<% elsif @story.created_at < 11.hour.ago && @story.created_at > 12.hour.ago %>
    <% round = 7 %>
    <% vote = true %>
<% elsif @story.created_at < 12.hour.ago && @story.created_at > 13.hour.ago %>
    <% round = 8 %>
    <% vote = false %>
<% elsif @story.created_at < 13.hour.ago && @story.created_at > 14.hour.ago %>
    <% round = 8 %>
    <% vote = true %>
<% elsif @story.created_at < 14.hour.ago && @story.created_at > 15.hour.ago %>
    <% round = 9 %>
    <% vote = false %>
<% elsif @story.created_at < 15.hour.ago && @story.created_at > 16.hour.ago %>
    <% round = 9 %>
    <% vote = true %>
<% end %>

<div class="pageContainer whitePageContainer">
    <div class="container">  
        <p id="notice"><%= notice %></p>
        <h1 class="storyTitle">
            <%= @story.title %>
            <span>
                Chapter 1 by <%= link_to(@story.user) do %>
                    <%= @story.user.name %>
                <% end %>
            </span>
        </h1>
        <p class="storyContent"><%= @story.content %></p>

        <% maxVotes = 0 %>
        <% chosenChapterRound = "" %>
        <% chosenChapters = [] %>
        <%-#= time_ago_in_words(@story.created_at) -%>
        <div>
            <% @story.chapters.each do |chapter| %>
                <% if round.to_s != chapter.round %>
                    <% if chosenChapterRound != chapter.round %>
                        <% maxVotes = 0 %>
                    <% end %>

                    <% if chapter.votes.count > maxVotes %>
                        <% maxVotes = chapter.votes.count %>
                        <% chosenChapterRound = chapter.round %>
                        <% chosenChapters[round.to_i] = chapter %>
                    <% end %>
                <% end %>
            <% end %>
            <% chosenChapters.each do |chosenChapter| %>
                <% if chosenChapter.nil? == false %>
                    <span class="chapterInfo">Chapter <%= chosenChapter.round %> by <a href="/users/<%= chosenChapter.author %>"><%= chosenChapter.authorname %></a></span>
                    <p class="storyContent"><%= chosenChapter.body %></p>
                <% end %>
            <% end %>
        </div>

    </div>
</div>

<div class="contentContainer">
    <div class="container">
        <%= @story.timeLeft %>
        <% if @story.timeLeft != false %>
            Time left:
            <div id="clock"></div>
            <script>
                console.log("hello");
                $('#clock').countdown('<%= @story.timeLeft %>').on('update.countdown', function(event) {
                    console.log("inside of countdown");
                    var $this = $(this).html(event.strftime('<span>%M</span> min'));
                });
            </script>
        <% end %>
        <% if vote == true %>
            <h2 class="chapterHeadline">Vote on chapter <%= round %></h2>
            <% @story.chapters.each do |chapter| %>
                <% if round.to_s == chapter.round %>
                    <div class="voteChapter-container">
                        <p class="voteChapter-content" style="float: left; width: 100%"><%= chapter.body %></p>
                    
                        <span class="pull-left"><%= pluralize(chapter.votes.count, "vote") %></span> 

                        <% if signed_in? %>
                            <%= button_to 'Vote', upvote_chapter_path(chapter), method: :post, class: "pull-left btn btn-inverse" %>
                        <% else %>
                        <%= link_to "Join to vote on your favorite", login_path, class: "btn btn-inverse" %>
                        <% end %>

                    </div>
                <% end %>
            <% end %>
        <% end %>
        <% if defined?(:round) && @story.created_at > 16.hour.ago && vote == false && signed_in? %>
            <h2 class="chapterHeadline">New chapter</h2>
            <p>In the next round, all readers can vote on their favorite chapter</p>
            <%= form_for([@story, @story.chapters.build]) do |f| %>
                <input id="chapter_round" name="chapter[round]" type="hidden" value="<%= round %>">
                <input id="chapter_author" name="chapter[author]" type="hidden" value="<%= current_user.id %>">
                <input id="chapter_authorname" name="chapter[authorname]" type="hidden" value="<%= current_user.name %>">
                <%= f.text_area :body, placeholder: "Continue the story" %>
                <div class="pull-right"><%= f.submit %></div>
            <% end %>
        <% end %>
    </div>
</div>